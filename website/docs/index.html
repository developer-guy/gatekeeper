<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.65">
<title data-react-helmet="true">Introduction | Gatekeeper</title><meta data-react-helmet="true" name="docsearch:version" content="current,latest"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Introduction | Gatekeeper"><meta data-react-helmet="true" name="description" content="Gatekeeper"><meta data-react-helmet="true" property="og:description" content="Gatekeeper"><meta data-react-helmet="true" property="og:url" content="https://sozercan.github.io/gatekeeper/website/docs/"><link data-react-helmet="true" rel="shortcut icon" href="/gatekeeper/website/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://sozercan.github.io/gatekeeper/website/docs/"><link rel="stylesheet" href="/gatekeeper/website/styles.633e5506.css">
<link rel="preload" href="/gatekeeper/website/styles.299f4447.js" as="script">
<link rel="preload" href="/gatekeeper/website/runtime~main.146836fc.js" as="script">
<link rel="preload" href="/gatekeeper/website/main.7b544dd1.js" as="script">
<link rel="preload" href="/gatekeeper/website/common.e9d304e7.js" as="script">
<link rel="preload" href="/gatekeeper/website/2.1fcec6d8.js" as="script">
<link rel="preload" href="/gatekeeper/website/12.2ce1d9db.js" as="script">
<link rel="preload" href="/gatekeeper/website/935f2afb.dafbfa41.js" as="script">
<link rel="preload" href="/gatekeeper/website/17896441.7b495326.js" as="script">
<link rel="preload" href="/gatekeeper/website/0e384e19.26da4cd4.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/gatekeeper/website/"><img class="navbar__logo" src="/gatekeeper/website/img/logo.svg" alt="My Site Logo"><strong class="navbar__title">Gatekeeper</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/gatekeeper/website/docs/">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/sozercan/gatekeeper" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/gatekeeper/website/"><img class="navbar__logo" src="/gatekeeper/website/img/logo.svg" alt="My Site Logo"><strong class="navbar__title">Gatekeeper</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/gatekeeper/website/docs/">Docs</a></li><li class="menu__list-item"><a href="https://github.com/sozercan/gatekeeper" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Docusaurus</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/gatekeeper/website/docs/">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/gatekeeper/website/docs/doc2">Document Number 2</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/gatekeeper/website/docs/doc3">This is Document Number 3</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/gatekeeper/website/docs/doc4">Style Guide</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Features</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/gatekeeper/website/docs/mdx">Powered by MDX</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">Introduction</h1></header><div class="markdown"><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="gatekeeper"></a>Gatekeeper<a aria-hidden="true" tabindex="-1" class="hash-link" href="#gatekeeper" title="Direct link to heading">#</a></h1><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="want-to-help"></a>Want to help?<a aria-hidden="true" tabindex="-1" class="hash-link" href="#want-to-help" title="Direct link to heading">#</a></h2><p>Join us to help define the direction and implementation of this project!</p><ul><li><p>Join the <a href="https://openpolicyagent.slack.com/messages/CDTN970AX" target="_blank" rel="noopener noreferrer"><code>#kubernetes-policy</code></a>
channel on <a href="https://slack.openpolicyagent.org/" target="_blank" rel="noopener noreferrer">OPA Slack</a>.</p></li><li><p>Join <a href="https://docs.google.com/document/d/1A1-Q-1OMw3QODs1wT6eqfLTagcGmgzAJAjJihiO3T48/edit" target="_blank" rel="noopener noreferrer">weekly meetings</a>
to discuss development, issues, use cases, etc.</p></li><li><p>Use <a href="https://github.com/open-policy-agent/gatekeeper/issues" target="_blank" rel="noopener noreferrer">GitHub Issues</a>
to file bugs, request features, or ask questions asynchronously.</p></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="how-is-gatekeeper-different-from-opa"></a>How is Gatekeeper different from OPA?<a aria-hidden="true" tabindex="-1" class="hash-link" href="#how-is-gatekeeper-different-from-opa" title="Direct link to heading">#</a></h2><p>Compared to using <a href="https://www.openpolicyagent.org/docs/kubernetes-admission-control.html" target="_blank" rel="noopener noreferrer">OPA with its sidecar kube-mgmt</a> (aka Gatekeeper v1.0), Gatekeeper introduces the following functionality:</p><ul><li>An extensible, parameterized policy library</li><li>Native Kubernetes CRDs for instantiating the policy library (aka &quot;constraints&quot;)</li><li>Native Kubernetes CRDs for extending the policy library (aka &quot;constraint templates&quot;)</li><li>Audit functionality</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="goals"></a>Goals<a aria-hidden="true" tabindex="-1" class="hash-link" href="#goals" title="Direct link to heading">#</a></h2><p>Every organization has policies. Some are essential to meet governance and legal requirements. Others help ensure adherance to best practices and institutional conventions. Attempting to ensure compliance manually would be error-prone and frustrating. Automating policy enforcement ensures consistency, lowers development latency through immediate feedback, and helps with agility by allowing developers to operate independently without sacrificing compliance.</p><p>Kubernetes allows decoupling policy decisions from the inner workings of the API Server by means of <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/" target="_blank" rel="noopener noreferrer">admission controller webhooks</a>, which are executed whenever a resource is created, updated or deleted. Gatekeeper is a validating (mutating TBA) webhook that enforces CRD-based policies executed by <a href="https://github.com/open-policy-agent/opa" target="_blank" rel="noopener noreferrer">Open Policy Agent</a>, a policy engine for Cloud Native environments hosted by CNCF as an incubation-level project.</p><p>In addition to the <code>admission</code> scenario, Gatekeeper&#x27;s audit functionality allows administrators to see what resources are currently violating any given policy.</p><p>Finally, Gatekeeper&#x27;s engine is designed to be portable, allowing administrators to detect and reject non-compliant commits to an infrastructure-as-code system&#x27;s source-of-truth, further strengthening compliance efforts and preventing bad state from slowing down the organization.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="admission-webhook-fail-open-status"></a>Admission Webhook Fail-Open Status<a aria-hidden="true" tabindex="-1" class="hash-link" href="#admission-webhook-fail-open-status" title="Direct link to heading">#</a></h2><p>Currently Gatekeeper is defaulting to using <code>failurePolicyâ€‹: â€‹Ignore</code> for admission request webhook errors. The impact of
this is that when the webhook is down, or otherwise unreachable, constraints will not be
enforced. Audit is expected to pick up any slack in enforcement by highlighting invalid
resources that made it into the cluster.</p><p>The reason for fail-open is because the webhook server currently only has one instance, which risks downtime
during actions like upgrades. If we were to fail closed, this downtime would lead to
downtime in the cluster&#x27;s control plane. We are currently working on addressing issues
that may cause multi-pod deployments of Gatekeeper to not work as expected. Once
we can improve availability by running in multiple pods, we will likely make
that setup the default and change our default webhook behavior to fail-closed (<code>failurePolicy: Fail</code>).</p><p>If desired, the webhook can be set to fail-closed by modifying the ValidatingWebhookConfiguration,
though this may have uptime impact on your cluster&#x27;s control plane. In the interim,
it is best to avoid policies that assume 100% enforcement during request
time (e.g. mimicking RBAC-like behavior by validating the user making the request).</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="installation-instructions"></a>Installation Instructions<a aria-hidden="true" tabindex="-1" class="hash-link" href="#installation-instructions" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="installation"></a>Installation<a aria-hidden="true" tabindex="-1" class="hash-link" href="#installation" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="prerequisites"></a>Prerequisites<a aria-hidden="true" tabindex="-1" class="hash-link" href="#prerequisites" title="Direct link to heading">#</a></h4><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="minimum-kubernetes-version"></a>Minimum Kubernetes Version<a aria-hidden="true" tabindex="-1" class="hash-link" href="#minimum-kubernetes-version" title="Direct link to heading">#</a></h5><p><strong>To use Gatekeeper, you should have a minimum Kubernetes version of 1.14, which adds
webhook timeouts.</strong></p><p>You can install Gatekeeper in earlier versions of Kubernetes either by
removing incompatible fields from the manifest or by setting <code>--validate=false</code>
when applying the manifest. Be warned that, without timeouts on the webhook, your
API Server could timeout when Gatekeeper is down. Kubernetes 1.14 fixes this issue.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="rbac-permissions"></a>RBAC Permissions<a aria-hidden="true" tabindex="-1" class="hash-link" href="#rbac-permissions" title="Direct link to heading">#</a></h5><p>For either installation method, make sure you have cluster admin permissions:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sh codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  kubectl create clusterrolebinding cluster-admin-binding \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --clusterrole cluster-admin \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --user &lt;YOUR USER NAME&gt;</span></div></div></div></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="deploying-a-release-using-prebuilt-image"></a>Deploying a Release using Prebuilt Image<a aria-hidden="true" tabindex="-1" class="hash-link" href="#deploying-a-release-using-prebuilt-image" title="Direct link to heading">#</a></h4><p>If you want to deploy a released version of Gatekeeper in your cluster with a prebuilt image, then you can run the following command:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sh codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/master/deploy/gatekeeper.yaml</span></div></div></div></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="deploying-head-using-make"></a>Deploying HEAD Using make<a aria-hidden="true" tabindex="-1" class="hash-link" href="#deploying-head-using-make" title="Direct link to heading">#</a></h4><p>Currently the most reliable way of installing Gatekeeper is to build and install from HEAD:</p><ul><li>Make sure that:<ul><li>You have Docker version 19.03 or later installed.</li><li><a href="https://github.com/kubernetes-sigs/kubebuilder#getting-started" target="_blank" rel="noopener noreferrer">Kubebuilder</a> and <a href="https://github.com/kubernetes-sigs/kustomize/blob/master/docs/INSTALL.md" target="_blank" rel="noopener noreferrer">Kustomize</a> are installed.</li><li>Your kubectl context is set to the desired installation cluster.</li><li>You have a container registry you can write to that is readable by the target cluster.</li></ul></li><li>Clone the Gatekeeper repository to your local system:<div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sh codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">git clone https://github.com/open-policy-agent/gatekeeper.git</span></div></div></div></div></div></li><li><code>cd</code> to the repository directory.</li><li>Define your destination Docker image location:<div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sh codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">export DESTINATION_GATEKEEPER_DOCKER_IMAGE=&lt;YOUR DESIRED DESTINATION DOCKER IMAGE&gt;</span></div></div></div></div></div></li><li>Build and push your Docker image:<div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sh codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">make docker-buildx REPOSITORY=&quot;$DESTINATION_GATEKEEPER_DOCKER_IMAGE&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">make docker-push-release REPOSITORY=&quot;$DESTINATION_GATEKEEPER_DOCKER_IMAGE&quot;</span></div></div></div></div></div></li><li>Finally, deploy:<div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sh codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">make deploy REPOSITORY=&quot;$DESTINATION_GATEKEEPER_DOCKER_IMAGE&quot;</span></div></div></div></div></div></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="deploying-via-helm"></a>Deploying via Helm<a aria-hidden="true" tabindex="-1" class="hash-link" href="#deploying-via-helm" title="Direct link to heading">#</a></h4><p>A basic Helm chart exists in <code>charts/gatekeeper</code>. If you have Helm installed, you can deploy via the following instructions for Helm v3:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sh codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">helm repo add gatekeeper https://open-policy-agent.github.io/gatekeeper/charts</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">helm install gatekeeper/gatekeeper --generate-name</span></div></div></div></div></div><p>If you are using the older Gatekeeper Helm repo location and Helm v3.3.2+, then use <code>force-update</code> to override the default behavior to update the existing repo.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sh codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">helm repo add gatekeeper https://open-policy-agent.github.io/gatekeeper/charts --force-update</span></div></div></div></div></div><p>Please note that this chart is compatible with Helm v3 starting with Gatekeeper v3.1.1. When using Helm v3, it is expected to see warnings regarding to <code>crd-install</code> hook. This is due to maintaining backwards compatibility with Helm v2 and should not impact the chart deployment.</p><p>You can alter the variables in <code>charts/gatekeeper/values.yaml</code> to customize your deployment. To regenerate the base template, run <code>make manifests</code>.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="policy-library"></a>Policy library<a aria-hidden="true" tabindex="-1" class="hash-link" href="#policy-library" title="Direct link to heading">#</a></h4><p>See the <a href="https://www.github.com/open-policy-agent/gatekeeper-library" target="_blank" rel="noopener noreferrer">Gatekeeper policy library</a> for a collection of constraint templates and sample constraints that you can use with Gatekeeper.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="uninstallation"></a>Uninstallation<a aria-hidden="true" tabindex="-1" class="hash-link" href="#uninstallation" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="uninstall-gatekeeper"></a>Uninstall Gatekeeper<a aria-hidden="true" tabindex="-1" class="hash-link" href="#uninstall-gatekeeper" title="Direct link to heading">#</a></h4><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="using-prebuilt-image"></a>Using Prebuilt Image<a aria-hidden="true" tabindex="-1" class="hash-link" href="#using-prebuilt-image" title="Direct link to heading">#</a></h5><p>If you used a prebuilt image to deploy Gatekeeper, then you can delete all the Gatekeeper components with the following command:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sh codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl delete -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/master/deploy/gatekeeper.yaml</span></div></div></div></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="using-make"></a>Using make<a aria-hidden="true" tabindex="-1" class="hash-link" href="#using-make" title="Direct link to heading">#</a></h5><p>If you used <code>make</code> to deploy, then run the following to uninstall Gatekeeper:</p><ul><li>cd to the repository directory</li><li>run <code>make uninstall</code></li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="using-helm"></a>Using Helm<a aria-hidden="true" tabindex="-1" class="hash-link" href="#using-helm" title="Direct link to heading">#</a></h5><p>If you used <code>helm</code> to deploy, then run the following to uninstall Gatekeeper:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sh codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">helm delete &lt;release name&gt;</span></div></div></div></div></div><p>Helm v3 will not cleanup Gatekeeper installed CRDs. Run the following to uninstall Gatekeeper CRDs:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sh codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl delete crd \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  configs.config.gatekeeper.sh \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  constraintpodstatuses.status.gatekeeper.sh \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  constrainttemplatepodstatuses.status.gatekeeper.sh \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  constrainttemplates.templates.gatekeeper.sh</span></div></div></div></div></div><p>This operation will also delete any user installed config changes, and constraint templates and constraints.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="how-to-use-gatekeeper"></a>How to Use Gatekeeper<a aria-hidden="true" tabindex="-1" class="hash-link" href="#how-to-use-gatekeeper" title="Direct link to heading">#</a></h2><p>Gatekeeper uses the <a href="https://github.com/open-policy-agent/frameworks/tree/master/constraint" target="_blank" rel="noopener noreferrer">OPA Constraint Framework</a> to describe and enforce policy. Look there for more detailed information on their semantics and advanced usage.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="constraint-templates"></a>Constraint Templates<a aria-hidden="true" tabindex="-1" class="hash-link" href="#constraint-templates" title="Direct link to heading">#</a></h3><p>Before you can define a constraint, you must first define a <code>ConstraintTemplate</code>, which describes both the <a href="https://www.openpolicyagent.org/docs/latest/#rego" target="_blank" rel="noopener noreferrer">Rego</a> that enforces the constraint and the schema of the constraint. The schema of the constraint allows an admin to fine-tune the behavior of a constraint, much like arguments to a function.</p><p>Here is an example constraint template that requires all labels described by the constraint to be present:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> templates.gatekeeper.sh/v1beta1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ConstraintTemplate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> k8srequiredlabels</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">crd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">names</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> K8sRequiredLabels</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">listKind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> K8sRequiredLabelsList</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">plural</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> k8srequiredlabels</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">singular</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> k8srequiredlabels</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">validation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Schema for the `parameters` field</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">openAPIV3Schema</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> array</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">items</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">targets</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">target</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> admission.k8s.gatekeeper.sh</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">rego</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(195, 232, 141)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">        package k8srequiredlabels</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        violation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token key atrule">&quot;msg&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token key atrule">&quot;details&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token key atrule">&quot;missing_labels&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> missing</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          provided </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">= </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">label </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> input.review.object.metadata.labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">label</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          required </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">= </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">label </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> label </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">= input.parameters.labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          missing </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">= required </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> provided</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          count(missing) </span><span class="token punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"> 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          msg </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">= sprintf(&quot;you must provide labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> %v&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">missing</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div></div></div><p>You can install this ConstraintTemplate with the following command:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sh codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/master/demo/basic/templates/k8srequiredlabels_template.yaml</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="constraints"></a>Constraints<a aria-hidden="true" tabindex="-1" class="hash-link" href="#constraints" title="Direct link to heading">#</a></h3><p>Constraints are then used to inform Gatekeeper that the admin wants a ConstraintTemplate to be enforced, and how. This constraint uses the <code>K8sRequiredLabels</code> constraint template above to make sure the <code>gatekeeper</code> label is defined on all namespaces:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> constraints.gatekeeper.sh/v1beta1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> K8sRequiredLabels</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">must</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">have</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">gk</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">match</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">kinds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">apiGroups</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">kinds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Namespace&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">parameters</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;gatekeeper&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span></div></div></div></div></div><p>You can install this Constraint with the following command:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sh codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/master/demo/basic/constraints/all_ns_must_have_gatekeeper.yaml</span></div></div></div></div></div><p>Note the <code>match</code> field, which defines the scope of objects to which a given constraint will be applied. It supports the following matchers:</p><ul><li><code>kinds</code> accepts a list of objects with <code>apiGroups</code> and <code>kinds</code> fields that list the groups/kinds of objects to which the constraint will apply. If multiple groups/kinds objects are specified, only one match is needed for the resource to be in scope.</li><li><code>scope</code> accepts <code>*</code>, <code>Cluster</code>, or <code>Namespaced</code> which determines if cluster-scoped and/or namesapced-scoped resources are selected. (defaults to <code>*</code>)</li><li><code>namespaces</code> is a list of namespace names. If defined, a constraint will only apply to resources in a listed namespace.</li><li><code>excludedNamespaces</code> is a list of namespace names. If defined, a constraint will only apply to resources not in a listed namespace.</li><li><code>labelSelector</code> is a standard Kubernetes label selector.</li><li><code>namespaceSelector</code> is a standard Kubernetes namespace selector. If defined, make sure to add <code>Namespaces</code> to your <code>configs.config.gatekeeper.sh</code> object to ensure namespaces are synced into OPA. Refer to the <a href="#replicating-data">Replicating Data section</a> for more details.</li></ul><p>Note that if multiple matchers are specified, a resource must satisfy each top-level matcher (<code>kinds</code>, <code>namespaces</code>, etc.) to be in scope. Each top-level matcher has its own semantics for what qualifies as a match. An empty matcher is deemed to be inclusive (matches everything). Also understand <code>namespaces</code>, <code>excludedNamespaces</code>, and <code>namespaceSelector</code> will match on cluster scoped resources which are not namespaced. To avoid this adjust the <code>scope</code> to <code>Namespaced</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="replicating-data"></a>Replicating Data<a aria-hidden="true" tabindex="-1" class="hash-link" href="#replicating-data" title="Direct link to heading">#</a></h3><p>Some constraints are impossible to write without access to more state than just the object under test. For example, it is impossible to know if an ingress&#x27;s hostname is unique among all ingresses unless a rule has access to all other ingresses. To make such rules possible, we enable syncing of data into OPA.</p><p>The audit feature does not require replication by default. However, when the <code>audit-from-cache</code> flag is set to true, the OPA cache will be used as the source-of-truth for audit queries; thus, an object must first be cached before it can be audited for constraint violations.</p><p>Kubernetes data can be replicated into OPA via the sync config resource. Currently resources defined in <code>syncOnly</code> will be synced into OPA. Updating <code>syncOnly</code> should dynamically update what objects are synced. Below is an example:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> config.gatekeeper.sh/v1alpha1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Config</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> config</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;gatekeeper-system&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">sync</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">syncOnly</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">group</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;v1&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Namespace&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">group</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;v1&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Pod&quot;</span></div></div></div></div></div><p>You can install this config with the following command:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sh codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/master/demo/basic/sync.yaml</span></div></div></div></div></div><p>Once data is synced into OPA, rules can access the cached data under the <code>data.inventory</code> document.</p><p>The <code>data.inventory</code> document has the following format:</p><ul><li>For cluster-scoped objects: <code>data.inventory.cluster[&lt;groupVersion&gt;][&lt;kind&gt;][&lt;name&gt;]</code><ul><li>Example referencing the Gatekeeper namespace: <code>data.inventory.cluster[&quot;v1&quot;].Namespace[&quot;gatekeeper&quot;]</code></li></ul></li><li>For namespace-scoped objects: <code>data.inventory.namespace[&lt;namespace&gt;][groupVersion][&lt;kind&gt;][&lt;name&gt;]</code><ul><li>Example referencing the Gatekeeper pod: <code>data.inventory.namespace[&quot;gatekeeper&quot;][&quot;v1&quot;][&quot;Pod&quot;][&quot;gatekeeper-controller-manager-d4c98b788-j7d92&quot;]</code></li></ul></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="audit"></a>Audit<a aria-hidden="true" tabindex="-1" class="hash-link" href="#audit" title="Direct link to heading">#</a></h3><p>The audit functionality enables periodic evaluations of replicated resources against the policies enforced in the cluster to detect pre-existing misconfigurations. Audit results are stored as violations listed in the <code>status</code> field of the failed constraint.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> constraints.gatekeeper.sh/v1beta1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> K8sRequiredLabels</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">must</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">have</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">gk</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">match</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">kinds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">apiGroups</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">kinds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Namespace&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">parameters</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;gatekeeper&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">status</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">auditTimestamp</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2019-05-11T01:46:13Z&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">enforced</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">violations</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">enforcementAction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> deny</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Namespace</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">message</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;you must provide labels: {&quot;gatekeeper&quot;}&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> default</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">enforcementAction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> deny</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Namespace</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">message</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;you must provide labels: {&quot;gatekeeper&quot;}&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> gatekeeper</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">system</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">enforcementAction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> deny</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Namespace</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">message</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;you must provide labels: {&quot;gatekeeper&quot;}&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">public</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">enforcementAction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> deny</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Namespace</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">message</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;you must provide labels: {&quot;gatekeeper&quot;}&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> kube</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">system</span></div></div></div></div></div><ul><li>Audit interval: set <code>--audit-interval=123</code> (defaults to every <code>60</code> seconds)</li><li>Audit violations per constraint: set <code>--constraint-violations-limit=123</code> (defaults to <code>20</code>)</li><li>Disable: set <code>--audit-interval=0</code></li></ul><p>By default, the audit will request each resource from the Kubernetes API during each cycle of the audit. To instead rely on the OPA cache, use the flag <code>--audit-from-cache=true</code>. Note that this requires replication of Kubernetes resources into OPA before they can be evaluated against the enforced policies. Refer to the <a href="#replicating-data">Replicating data</a> section for more information.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="audit-using-kinds-specified-in-the-constraints-only"></a>Audit using kinds specified in the constraints only<a aria-hidden="true" tabindex="-1" class="hash-link" href="#audit-using-kinds-specified-in-the-constraints-only" title="Direct link to heading">#</a></h4><p>By default, Gatekeeper will audit all resources in the cluster. This operation can take some time depending on the number of resources.</p><p>If all of your constraints match against specific kinds (e.g. &quot;match only pods&quot;), then you can speed up audit runs by setting <code>--audit-match-kind-only=true</code> flag. This will only check resources of the kinds specified in all <a href="#Constraints">constraints</a> defined in the cluster.</p><p>For example, defining this constraint will only audit <code>Pod</code> kind:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> constraints.gatekeeper.sh/v1beta1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> K8sAllowedRepos</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> prod</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">repo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">is</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">openpolicyagent</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">match</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">kinds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">apiGroups</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">kinds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Pod&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">...</span></div></div></div></div></div><p>If any of the <a href="#Constraints">constraints</a> do not specify <code>kinds</code>, it will be equivalent to not setting <code>--audit-match-kind-only</code> flag (<code>false</code> by default), and will fall back to auditing all resources in the cluster.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="log-denies"></a>Log denies<a aria-hidden="true" tabindex="-1" class="hash-link" href="#log-denies" title="Direct link to heading">#</a></h3><p>Set the <code>--log-denies</code> flag to log all denies and dryrun failures.
This is useful when trying to see what is being denied/fails dry-run and keeping a log to debug cluster problems without having to enable syncing or looking through the status of all constraints.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="dry-run"></a>Dry Run<a aria-hidden="true" tabindex="-1" class="hash-link" href="#dry-run" title="Direct link to heading">#</a></h3><p>When rolling out new constraints to running clusters, the dry run functionality can be helpful as it enables constraints to be deployed in the cluster without making actual changes. This allows constraints to be tested in a running cluster without enforcing them. Cluster resources that are impacted by the dry run constraint are surfaced as violations in the <code>status</code> field of the constraint.</p><p>To use the dry run feature, add <code>enforcementAction: dryrun</code> to the constraint spec to ensure no actual changes are made as a result of the constraint. By default, <code>enforcementAction</code> is set to <code>deny</code> as the default behavior is to deny admission requests with any violation.</p><p>For example:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> constraints.gatekeeper.sh/v1beta1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> K8sRequiredLabels</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">must</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">have</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">gk</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">enforcementAction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dryrun</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">match</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">kinds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">apiGroups</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">kinds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Namespace&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">parameters</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;gatekeeper&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">status</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">auditTimestamp</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2019-08-15T01:46:13Z&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">enforced</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">violations</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">enforcementAction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dryrun</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Namespace</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">message</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;you must provide labels: {&quot;gatekeeper&quot;}&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> default</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">enforcementAction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dryrun</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Namespace</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">message</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;you must provide labels: {&quot;gatekeeper&quot;}&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> gatekeeper</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">system</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div></div></div><blockquote><p>NOTE: The supported enforcementActions are [<code>deny</code>, <code>dryrun</code>] for constraints. Update the <code>--disable-enforcementaction-validation=true</code> flag if the desire is to disable enforcementAction validation against the list of supported enforcementActions.</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="exempting-namespaces-from-gatekeeper"></a>Exempting Namespaces from Gatekeeper<a aria-hidden="true" tabindex="-1" class="hash-link" href="#exempting-namespaces-from-gatekeeper" title="Direct link to heading">#</a></h3><p>Config resource can be used as follows to exclude namespaces from certain processes for all constraints in the cluster. To exclude namespaces at a constraint level, use <code>excludedNamespaces</code> in the <a href="#constraints">constraint</a> instead.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> config.gatekeeper.sh/v1alpha1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Config</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> config</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;gatekeeper-system&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">match</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">excludedNamespaces</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;kube-system&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;gatekeeper-system&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">processes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;*&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">excludedNamespaces</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;audit-excluded-ns&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">processes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;audit&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">excludedNamespaces</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;audit-webhook-sync-excluded-ns&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">processes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;audit&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;webhook&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;sync&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">...</span></div></div></div></div></div><p>Available processes:</p><ul><li><code>audit</code> process exclusion will exclude resources from specified namespace(s) in audit results.</li><li><code>webhook</code> process exclusion will exclude resources from specified namespace(s) from the admission webhook.</li><li><code>sync</code> process exclusion will exclude resources from specified namespace(s) from being synced into OPA.</li><li><code>*</code> includes all current processes above and includes any future processes.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="exempting-namespaces-from-the-gatekeeper-admission-webhook-using---exempt-namespace-flag"></a>Exempting Namespaces from the Gatekeeper Admission Webhook using <code>--exempt-namespace</code> flag<a aria-hidden="true" tabindex="-1" class="hash-link" href="#exempting-namespaces-from-the-gatekeeper-admission-webhook-using---exempt-namespace-flag" title="Direct link to heading">#</a></h4><p>Note that the following only exempts resources from the admission webhook. They will still be audited. Editing individual constraints is
necessary to exclude them from audit.</p><p>If it becomes necessary to exempt a namespace from Gatekeeper entirely (e.g. you want <code>kube-system</code> to bypass admission checks), here&#x27;s how to do it:</p><ol><li><p>Make sure the validating admission webhook configuration for Gatekeeper has the following namespace selector:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">namespaceSelector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">matchExpressions</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> admission.gatekeeper.sh/ignore</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">operator</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DoesNotExist</span></div></div></div></div></div><p>the default Gatekeeper manifest should already have added this. The default name for the
webhook configuration is <code>gatekeeper-validating-webhook-configuration</code> and the default
name for the webhook that needs the namespace selector is <code>validation.gatekeeper.sh</code></p></li><li><p>Tell Gatekeeper it&#x27;s okay for the namespace to be ignored by adding a flag to the pod:
<code>--exempt-namespace=&lt;NAMESPACE NAME&gt;</code>. This step is necessary because otherwise the
permission to modify a namespace would be equivalent to the permission to exempt everything
in that namespace from policy checks. This way a user must explicitly have permissions
to configure the Gatekeeper pod before they can add exemptions.</p></li><li><p>Add the <code>admission.gatekeeper.sh/ignore</code> label to the namespace. The value attached
to the label is ignored, so it can be used to annotate the reason for the exemption.</p></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="debugging"></a>Debugging<a aria-hidden="true" tabindex="-1" class="hash-link" href="#debugging" title="Direct link to heading">#</a></h3><blockquote><p>NOTE: Verbose logging with DEBUG level can be turned on with <code>--log-level=DEBUG</code>.  By default, the <code>--log-level</code> flag is set to minimum log level <code>INFO</code>. Acceptable values for minimum log level are [<code>DEBUG</code>, <code>INFO</code>, <code>WARNING</code>, <code>ERROR</code>]. In production, this flag should not be set to <code>DEBUG</code>.</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="enable-delete-operations"></a>Enable Delete Operations<a aria-hidden="true" tabindex="-1" class="hash-link" href="#enable-delete-operations" title="Direct link to heading">#</a></h3><p>To enable Delete operations for the <code>validation.gatekeeper.sh</code> admission webhook, add &quot;DELETE&quot; to the list of operations in the <code>gatekeeper-validating-webhook-configuration</code> ValidatingWebhookConfiguration as seen in this deployment manifest of gatekeeper: <a href="https://github.com/open-policy-agent/gatekeeper/blob/v3.1.0-beta.10/deploy/gatekeeper.yaml#L792-L794" target="_blank" rel="noopener noreferrer">here</a>
Note: For admission webhooks registered for DELETE operations, use Kubernetes v1.15.0+</p><p> So you have</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-YAML codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">   operations:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   - CREATE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   - UPDATE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   - DELETE</span></div></div></div></div></div><p>You can now check for deletes.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="viewing-the-request-object"></a>Viewing the Request Object<a aria-hidden="true" tabindex="-1" class="hash-link" href="#viewing-the-request-object" title="Direct link to heading">#</a></h4><p>A simple way to view the request object is to use a constraint/template that
denies all requests and outputs the request object as its rejection message.</p><p>Example template:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> templates.gatekeeper.sh/v1beta1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ConstraintTemplate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> k8sdenyall</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">crd</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">names</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> K8sDenyAll</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">targets</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">target</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> admission.k8s.gatekeeper.sh</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">rego</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(195, 232, 141)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">        package k8sdenyall</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        violation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token key atrule">&quot;msg&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> msg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          msg </span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">= sprintf(&quot;REVIEW OBJECT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> %v&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">input.review</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div></div></div><p>Example constraint:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> constraints.gatekeeper.sh/v1beta1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> K8sDenyAll</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> deny</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">all</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">namespaces</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">match</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">kinds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">apiGroups</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">kinds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Namespace&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span></div></div></div></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="tracing"></a>Tracing<a aria-hidden="true" tabindex="-1" class="hash-link" href="#tracing" title="Direct link to heading">#</a></h4><p>In debugging decisions and constraints, a few pieces of information can be helpful:</p><ul><li>Cached data and existing rules at the time of the request</li><li>A trace of the evaluation</li><li>The input document being evaluated</li></ul><p>Writing out this information for every request would be very expensive, and it would be hard
to find the relevant logs for a given request. Instead, Gatekeeper allows users to specify
resources and requesting users for which information will be logged. They can do so by
configuring the <code>Config</code> resource, which lives in the <code>gatekeeper-system</code> namespace.</p><p>Below is an example of a config resource:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> config.gatekeeper.sh/v1alpha1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Config</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> config</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;gatekeeper-system&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Data to be replicated into OPA</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">sync</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">syncOnly</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">group</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;v1&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Namespace&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">validation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Requests for which we want to run traces</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">traces</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># The requesting user for which traces will be run</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;user_to_trace@company.com&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># The group, version, kind for which we want to run a trace</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">group</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;v1&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Namespace&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># If dump is defined and set to `All`, also dump the state of OPA</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">dump</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;All&quot;</span></div></div></div></div></div><p>Traces will be written to the stdout logs of the Gatekeeper controller.</p><p>If there is an error in the Rego in the ConstraintTemplate, there are cases where it is still created via <code>kubectl apply -f [CONSTRAINT_TEMPLATE_FILENAME].yaml</code>.</p><p>When applying the constraint using <code>kubectl apply -f constraint.yaml</code> with a ConstraintTemplate that contains incorrect Rego, and error will occur: <code>error: unable to recognize &quot;[CONSTRAINT_FILENAME].yaml&quot;: no matches for kind &quot;[NAME_OF_CONSTRAINT]&quot; in version &quot;constraints.gatekeeper.sh/v1beta1&quot;</code>.</p><p>To find the error, run <code>kubectl get -f [CONSTRAINT_FILENAME].yaml -oyaml</code>. Build errors are shown in the <code>status</code> field.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="customizing-admission-behavior"></a>Customizing Admission Behavior<a aria-hidden="true" tabindex="-1" class="hash-link" href="#customizing-admission-behavior" title="Direct link to heading">#</a></h3><p>Gatekeeper is a <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#webhook-configuration" target="_blank" rel="noopener noreferrer">Kubernetes admission webhook</a>
whose default configuration can be found in the <code>gatekeeper.yaml</code> manifest file. By default, it is
a <code>ValidatingWebhookConfiguration</code> resource named <code>gatekeeper-validating-webhook-configuration</code>.</p><p>Currently the configuration specifies two webhooks: one for checking a request against
the installed constraints and a second webhook for checking labels on namespace requests
that would result in bypassing constraints for the namespace. The namespace-label webhook
is necessary to prevent a privilege escalation where the permission to add a label to a
namespace is equivalent to the ability to bypass all constraints for that namespace.
You can read more about the ability to exempt namespaces by label <a href="#exempting-namespaces-from-the-gatekeeper-admission-webhook">above</a>.</p><p>Because Kubernetes adds features with each version, if you want to know how the webhook can be configured it
is best to look at the official documentation linked at the top of this section. However, two particularly important
configuration options deserve special mention: <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#timeouts" target="_blank" rel="noopener noreferrer">timeouts</a> and
<a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#failure-policy" target="_blank" rel="noopener noreferrer">failure policy</a>.</p><p>Timeouts allow you to configure how long the API server will wait for a response from the admission webhook before it
considers the request to have failed. Note that setting the timeout longer than the overall request timeout
means that the main request will time out before the webhook&#x27;s failure policy is invoked.</p><p>Failure policy controls what happens when a webhook fails for whatever reason. Common
failure scenarios include timeouts, a 5xx error from the server or the webhook being unavailable.
You have the option to ignore errors, allowing the request through, or failing, rejecting the request.
This results in a direct tradeoff between availability and enforcement.</p><p>Currently Gatekeeper is defaulting to using <code>Ignore</code> for the constraint requests. This is because
the webhook server currently only has one instance, which risks downtime during actions like upgrades.
As the theoretical availability improves we will likely change the default to <code>Fail</code>.</p><p>The namespace label webhook defaults to <code>Fail</code>, this is to help ensure that policies preventing
labels that bypass the webhook from being applied are enforced. Because this webhook only gets
called for namespace modification requests, the impact of downtime is mitigated, making the
theoretical maximum availability less of an issue.</p><p>Because the manifest is available for customization, the webhook configuration can
be tuned to meet your specific needs if they differ from the defaults.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="emergency-recovery"></a>Emergency Recovery<a aria-hidden="true" tabindex="-1" class="hash-link" href="#emergency-recovery" title="Direct link to heading">#</a></h3><p>If a situation arises where Gatekeeper is preventing the cluster from operating correctly,
the webhook can be disabled. This will remove all Gatekeeper admission checks. Assuming
the default webhook name has been used this can be achieved by running:</p><p><code>kubectl delete validatingwebhookconfigurations.admissionregistration.k8s.io gatekeeper-validating-webhook-configuration</code></p><p>Redeploying the webhook configuration will re-enable Gatekeeper.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="running-on-private-gke-cluster-nodes"></a>Running on private GKE Cluster nodes<a aria-hidden="true" tabindex="-1" class="hash-link" href="#running-on-private-gke-cluster-nodes" title="Direct link to heading">#</a></h3><p>By default, firewall rules restrict the cluster master communication to nodes only on ports 443 (HTTPS) and 10250 (kubelet). Although Gatekeeper exposes its service on port 443, GKE by default enables <code>--enable-aggregator-routing</code> option, which makes the master to bypass the service and communicate straight to the POD on port 8443.</p><p>Two ways of working around this:</p><ul><li><p>create a new firewall rule from master to private nodes to open port <code>8443</code> (or any other custom port)</p><ul><li><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/private-clusters#add_firewall_rules" target="_blank" rel="noopener noreferrer">https://cloud.google.com/kubernetes-engine/docs/how-to/private-clusters#add_firewall_rules</a></li></ul></li><li><p>make the pod to run on privileged port 443 (need to run pod as root)</p><ul><li><p>update Gatekeeper deployment manifest spec:</p><ul><li>remove <code>securityContext</code> settings that force the pods not to run as root</li><li>update port from <code>8443</code> to <code>443</code></li></ul><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">port=443</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">containerPort</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> webhook</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">server</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">protocol</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> TCP</span></div></div></div></div></div></li><li><p>update Gatekeeper service manifest spec:</p><ul><li>update <code>targetPort</code> from <code>8443</code> to <code>443</code></li></ul><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">targetPort</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">443</span></div></div></div></div></div></li></ul></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="running-on-openshift-4x"></a>Running on OpenShift 4.x<a aria-hidden="true" tabindex="-1" class="hash-link" href="#running-on-openshift-4x" title="Direct link to heading">#</a></h3><p>When running on OpenShift, the <code>nouid</code> scc must be used to keep a restricted profile but being able to set the UserID.</p><p>In order to use it, the following section must be added to the gatekeeper-manager-role Role:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">apiGroups</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> security.openshift.io</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">resourceNames</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> anyuid</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> securitycontextconstraints</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">verbs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> use</span></div></div></div></div></div><p>With this restricted profile, it won&#x27;t be possible to set the <code>container.seccomp.security.alpha.kubernetes.io/manager: runtime/default</code> annotation. On the other hand, given the limited amount of privileges provided by the anyuid scc, the annotation can be removed.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="kick-the-tires"></a>Kick The Tires<a aria-hidden="true" tabindex="-1" class="hash-link" href="#kick-the-tires" title="Direct link to heading">#</a></h2><p>The <a href="https://github.com/open-policy-agent/gatekeeper/tree/master/demo/basic" target="_blank" rel="noopener noreferrer">demo/basic</a> directory contains the above examples of simple constraints, templates and configs to play with. The <a href="https://github.com/open-policy-agent/gatekeeper/tree/master/demo/agilebank" target="_blank" rel="noopener noreferrer">demo/agilebank</a> directory contains more complex examples based on a slightly more realistic scenario. Both folders have a handy demo script to step you through the demos.</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="security"></a>Security<a aria-hidden="true" tabindex="-1" class="hash-link" href="#security" title="Direct link to heading">#</a></h1><p>Please report vulnerabilities by email to <a href="mailto:open-policy-agent-security@googlegroups.com" target="_blank" rel="noopener noreferrer">open-policy-agent-security</a>.
We will send a confirmation message to acknowledge that we have received the
report and then we will send additional messages to follow up once the issue
has been investigated.</p><p>For details on the security release process please refer to the <a href="https://github.com/open-policy-agent/opa/blob/master/SECURITY.md" target="_blank" rel="noopener noreferrer">open-policy-agent/opa/SECURITY.md</a> file.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/master/website/docs/intro.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/gatekeeper/website/docs/doc2"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Document Number 2 Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#want-to-help" class="table-of-contents__link">Want to help?</a></li><li><a href="#how-is-gatekeeper-different-from-opa" class="table-of-contents__link">How is Gatekeeper different from OPA?</a></li><li><a href="#goals" class="table-of-contents__link">Goals</a></li><li><a href="#admission-webhook-fail-open-status" class="table-of-contents__link">Admission Webhook Fail-Open Status</a></li><li><a href="#installation-instructions" class="table-of-contents__link">Installation Instructions</a><ul><li><a href="#installation" class="table-of-contents__link">Installation</a></li><li><a href="#uninstallation" class="table-of-contents__link">Uninstallation</a></li></ul></li><li><a href="#how-to-use-gatekeeper" class="table-of-contents__link">How to Use Gatekeeper</a><ul><li><a href="#constraint-templates" class="table-of-contents__link">Constraint Templates</a></li><li><a href="#constraints" class="table-of-contents__link">Constraints</a></li><li><a href="#replicating-data" class="table-of-contents__link">Replicating Data</a></li><li><a href="#audit" class="table-of-contents__link">Audit</a></li><li><a href="#log-denies" class="table-of-contents__link">Log denies</a></li><li><a href="#dry-run" class="table-of-contents__link">Dry Run</a></li><li><a href="#exempting-namespaces-from-gatekeeper" class="table-of-contents__link">Exempting Namespaces from Gatekeeper</a></li><li><a href="#debugging" class="table-of-contents__link">Debugging</a></li><li><a href="#enable-delete-operations" class="table-of-contents__link">Enable Delete Operations</a></li><li><a href="#customizing-admission-behavior" class="table-of-contents__link">Customizing Admission Behavior</a></li><li><a href="#emergency-recovery" class="table-of-contents__link">Emergency Recovery</a></li><li><a href="#running-on-private-gke-cluster-nodes" class="table-of-contents__link">Running on private GKE Cluster nodes</a></li><li><a href="#running-on-openshift-4x" class="table-of-contents__link">Running on OpenShift 4.x</a></li></ul></li><li><a href="#kick-the-tires" class="table-of-contents__link">Kick The Tires</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/gatekeeper/website/docs/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/gatekeeper/website/docs/doc2/">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="text--center"><div>Copyright Â© 2020 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/gatekeeper/website/styles.299f4447.js"></script>
<script src="/gatekeeper/website/runtime~main.146836fc.js"></script>
<script src="/gatekeeper/website/main.7b544dd1.js"></script>
<script src="/gatekeeper/website/common.e9d304e7.js"></script>
<script src="/gatekeeper/website/2.1fcec6d8.js"></script>
<script src="/gatekeeper/website/12.2ce1d9db.js"></script>
<script src="/gatekeeper/website/935f2afb.dafbfa41.js"></script>
<script src="/gatekeeper/website/17896441.7b495326.js"></script>
<script src="/gatekeeper/website/0e384e19.26da4cd4.js"></script>
</body>
</html>